
<!doctype html>
<html lang="en">

<head> 
<script src="/js/skipto.min.js"></script>
<script> var SkipToConfig =  { 'settings': { 'skipTo': { displayOption: 'popup' } } }; </script>
  
  <link rel="stylesheet" href="/css/edthedev.css" /> 
  <title>Christmas in Luanti - by Edward Delaporte</title>

<nav class="ye_navbar" role="navigation"> 
  <span class="ye_navbar">
    <ul><li><a href="/">Edward.Delaporte.us</a></li>
<li><a href="/slides/">Slides</a></li>
<li><a href="/code/">Code</a></li>
<li><a href="/art/">Art</a></li>
<li><a href="/blog/">Blog</a></li>
<li><a href="/resume/">Resume</a></li></ul>
  </span>
</nav>

<style>

h2 {
/* For use with more_nav */
  border-bottom-style:none;
  box-shadow: none;
}

</style>

</head> 
<body>

<div class="content" role="main">
  <h1> Christmas in Luanti </h1>

  <p>Merry Christmas, everyone!</p>
<p>Let's add some Christmas decor to Luanti!</p>
<p><img src="/img/blog/luanti_christmas.jpg" alt="a Luanti screenshot showing my inventory open with a candy cane, tinsel, garland and other Christmas decor"></p>
<p>The commands below use <a href="https://codeberg.org/EdTheDev/dotfiles/src/branch/main/invoke/luanti-remote/tasks.py">my Luanti invoke file</a>.</p>
<p>First, I downloaded <code>Christmas Decor</code> in my local copy of Luanti, on my laptop.</p>
<p>Next, a few commands.</p>
<p>I shutdown my Luanti server:</p>
<pre><code class="language-sh">ssh $USER_AT_IP
screen -r
Ctrl+C
</code></pre>
<p>I need to know the mod folder name, so I run <code>invoke list-local-mods | grep christmas</code></p>
<p>Here's the invoke source code to <code>list-local-mods</code> (from <a href="https://codeberg.org/EdTheDev/dotfiles/src/branch/main/invoke/luanti-remote/tasks.py">my invoke file</a>).</p>
<pre><code class="language-python">@task
def list_local_mods(c):
    c.run(f'ls -al {LOCAL_LUANTI}/mods')
</code></pre>
<p>Then I compress, push, and unpack the mod with <code>invoke push-local-mod christmas_decor</code></p>
<p>Here's the invoke source code to <code>push-local-mod</code> (from <a href="https://codeberg.org/EdTheDev/dotfiles/src/branch/main/invoke/luanti-remote/tasks.py">my invoke file</a>).</p>
<pre><code class="language-python">@task
def push_local_mod(c, mod):
    tarfile = f'{LOCAL_BACKUPS}/mods/{mod}.tar'
    print(f'Compressing local mod {mod} to {tarfile}')
    c.run(f'tar cf {tarfile} --directory={LOCAL_LUANTI}/mods {mod}')
    c.run(f'tar --list -f {tarfile} | tail')
    c.run(f'tar --list -f {tarfile} | wc')

    print(f'Pushing {tarfile} to {USER_AT_IP}:/tmp')
    c.run(f'scp {tarfile} {USER_AT_IP}:/tmp')
    c.run(f'{SSH} -C ls /tmp | grep {mod}')

    print(f'Unpacking {mod}.tar...')
    c.run(f'{SSH} -C tar xf /tmp/{mod}.tar --directory {MODS}')
    c.run(f'{SSH} -C ls -l {MODS} | grep {mod}')
    c.run(f'{SSH} -C ls -l {MODS}/{mod}')

    print(f'Enable {mod} in config')
    print(f'Remember to enable {mod} in config (invoke enable-mod {mod})')

</code></pre>
<p>Next, I still need to enable the mod in my world config file, with <code>invoke enable-mod christmas_decor</code>.</p>
<p>Here's the source code for that. We get a bit fancier here, because we don't want the enable configuration line to get added over and over again if I repeat the command.</p>
<pre><code class="language-python">@task
def enable_mod(c, mod):
    enable_line = f'load_mod_{mod} = mods/{mod}'
    result = c.run(f'{SSH} -C cat {WORLD_CONF} | grep {mod} &amp;2&gt;/dev/null')
    print(result.stdout)
    if(not mod in result.stdout):
        print(f'Mod {mod} not found in {WORLD_CONF}. Adding.')
        c.run(f'{SSH} -C &quot;echo {enable_line} &gt;&gt; {WORLD_CONF}&quot;')
    else:
        print(f'{MOD} already enabled in {WORLD_CONF}')
        print(f'Grep result: {result.stdout}')
    print(&quot;Remember to restart the server (invoke serve)!&quot;)


</code></pre>
<p>Finally, I need to restart the server with <code>invoke serve</code>.</p>
<p>But, my <code>invoke serve</code> command does not allow me to proceed without a verified backup from today, so I need to run a couple of commands, first.</p>
<p>So I must call <code>invoke backup</code> and then <code>invoke verify-backup</code>.</p>
<p>Backing up without stopping the server results in a corrupt world database, so I take some extra precautions during these steps.</p>
<p>Note that <code>invoke backup</code> calls <code>compress_world</code> first automatically, so here's the source code to all three:</p>
<pre><code class="language-python">@task
def compress_world(c):
    c.run(f'{SSH} -C tar cf {HOME}/{BACKUP_FILE} --directory={WORLDS} {WORLD}')

@task(compress_world)
def backup(c):
    stopped = input(&quot;Is the server stopped?&quot;)
    if(stopped != 'y'):
        print(&quot;so go stop the server...&quot;)
        exit()
    print(f'Backup {HOME}/{BACKUP_FILE} to {LOCAL_BACKUPS}')
    c.run(f'mkdir -p {LOCAL_BACKUPS}')
    c.run(f'{SCP}:{BACKUP_FILE} {LOCAL_BACKUPS}')
    print(f'Backedup up {BACKUP_FILE} to {LOCAL_BACKUPS}')
    c.run(f'ls -lh {LOCAL_BACKUPS} | grep {WORLD}')
    c.run(f'tar tvf {LOCAL_BACKUPS}/{BACKUP_FILE}')

@task
def verify_backup(c):
    TAR_FILE=f'{LOCAL_BACKUPS}/{BACKUP_FILE}'
    DB_FILE='map.sqlite'
    print(f'Extracting {DB_FILE} from {TAR_FILE}')
    c.run(f'cd /tmp;tar --extract --file={LOCAL_BACKUPS}/{BACKUP_FILE} {WORLD}/{DB_FILE}')
    result = c.run(f'echo &quot;PRAGMA quick_check;&quot; | sqlite3 /tmp/{DB_FILE}')
    # print(f'Check on {DB_FILE}: {result}')
    # print(f'Exit code: {result.exited}')

    if(not 'ok' in result.stdout):
        print(&quot;=========================================&quot;)
        print(&quot;database is corrupt, restore from backup!&quot;)
        print(&quot;=========================================&quot;)
</code></pre>
<p>Now, I can restart the server, and login to enjoy some new Christmas decor!</p>
<pre><code class="language-python">@task(verify_backup)
def serve(c):
    print(f&quot;Attempting to connect to {IP}&quot;)
    result = c.run(f'ssh {USER}@{IP} -C {SERVE}')
    print(f'Server should now be running in a remote screen session.')
    print(result)
</code></pre>
<p>Here's the full set of commands, without the pauses to read source code:</p>
<pre><code class="language-sh">ssh $USER_AT_IP
screen -r
Ctrl+C
# Download the `Christmas Decor` mod using my local Luanti client
invoke list-local-mods | grep christmas  # To learn the folder name is `christmas_decor`
$MOD=christmas_decor
invoke push-local-mod christmas_decor
invoke enable-mod christmas_decor
invoke backup
# Press 'y' to confirm that I stopped the server earlier.
invoke serve  # runs `verify-backup`, before starting the server.
</code></pre>

</div>
<div class="content" role="contentinfo">
  <a href="https://edward.delaporte.us/slides/share.html#text=Christmas in Luanti%20-%20https://edward.delaporte.us/blog/luanti/christmas/ ">Share on Mastodon</a>
  <p>
  This work ©2020-2025 by Edward Delaporte is licensed under 
  <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/?ref=chooser-v1">CC BY-NC-SA 4.0</a>
  </p>
</div>
<div style="display: flex; gap: 0.25rem; justify-content: center">
   <p>Click the links below to explore the <a href="https://www.webringworld.org/">web ring</a> I joined.</p>
  <a href="https://graphics-programming.org/webring/frogs/edthedev/prev">⬅️</a>
  <a href="https://graphics-programming.org/webring/">
    <img
      src="https://graphics-programming.org/img/froge.webp"
      alt="a friendly froge"
      style="object-fit: contain; width: 1.5em; height: 1.5em"
    />
  </a>
  <a href="https://graphics-programming.org/webring/frogs/edthedev/next">➡️</a>
</div>

</html>
